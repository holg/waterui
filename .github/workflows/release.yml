name: Release

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-plz:
    name: Release
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Work around missing workspace member in old commit
        shell: bash
        run: |
          # release-plz checks out historical commits while comparing packages with crates.io.
          # In this repo, the `derive/` crate was deleted, but the workspace `members` list kept
          # referencing it for a few subsequent commits, causing `cargo metadata`/`cargo package`
          # to fail when release-plz checks out any of those commits.
          #
          # Work around it in CI by using `git replace` to "patch" each affected commit with a
          # new one that adds a minimal `derive/` crate. This avoids rewriting history.
          set -euo pipefail

          echo "GIT_NO_REPLACE_OBJECTS=${GIT_NO_REPLACE_OBJECTS-<unset>}"
          git --version
          git config core.replaceRefs true

          ORIGINAL_SHA="$(git rev-parse HEAD)"
          ORIGINAL_BRANCH="$(git symbolic-ref -q --short HEAD || true)"
          if [[ -z "${ORIGINAL_BRANCH}" ]]; then
            # `actions/checkout` can leave the repo in detached HEAD state.
            # Create a local branch so release-plz can determine the current branch.
            ORIGINAL_BRANCH="main"
            git checkout -q -B "${ORIGINAL_BRANCH}" "${ORIGINAL_SHA}"
          fi

          git config user.email "release-plz-ci@users.noreply.github.com"
          git config user.name "release-plz-ci"

          BROKEN_COMMITS=()
          while IFS= read -r sha; do
            if ! git cat-file -e "${sha}:Cargo.toml" 2>/dev/null; then
              continue
            fi

            # Only consider commits where `derive` is a workspace member.
            if ! git show "${sha}:Cargo.toml" 2>/dev/null | awk '
              BEGIN { in_members = 0 }
              /^[[:space:]]*members[[:space:]]*=[[:space:]]*\\[/ { in_members = 1 }
              in_members { print }
              in_members && /\\]/ { exit }
            ' | grep -q '"derive"'; then
              continue
            fi

            # Skip commits where `derive/` exists.
            if git cat-file -e "${sha}:derive/Cargo.toml" 2>/dev/null; then
              continue
            fi

            BROKEN_COMMITS+=("$sha")
          done < <(git rev-list --reverse HEAD)

          if [[ ${#BROKEN_COMMITS[@]} -eq 0 ]]; then
            echo "No broken commits found; skipping workaround."
            exit 0
          fi

          echo "Applying git-replace workaround for ${#BROKEN_COMMITS[@]} commit(s): ${BROKEN_COMMITS[*]}"

          for BROKEN_SHA in "${BROKEN_COMMITS[@]}"; do
            if git show-ref --verify --quiet "refs/replace/${BROKEN_SHA}"; then
              echo "Replacement already exists for ${BROKEN_SHA}; skipping."
              continue
            fi

            echo "Patching commit ${BROKEN_SHA}..."

            # Create a replacement commit with the *same parents* as the broken commit.
            # IMPORTANT: don't create it as a child of BROKEN_SHA (that would create a cycle).
            PARENTS_STR="$(git show -s --format=%P "${BROKEN_SHA}")"

            git checkout -q "${BROKEN_SHA}"
            mkdir -p derive/src
            printf '%s\n' \
              '[package]' \
              'name = "waterui-derive-placeholder"' \
              'version = "0.0.0"' \
              'edition = "2021"' \
              'publish = false' \
              > derive/Cargo.toml
            echo "pub fn _placeholder() {}" > derive/src/lib.rs
            git add derive

            TREE_SHA="$(git write-tree)"
            PARENT_ARGS=()
            for p in ${PARENTS_STR}; do
              PARENT_ARGS+=("-p" "$p")
            done
            FIX_SHA="$(printf '%s\n' "chore: add placeholder derive workspace member" | git commit-tree "${TREE_SHA}" "${PARENT_ARGS[@]}")"
            git reset -q --hard

            if [[ -n "${ORIGINAL_BRANCH}" ]]; then
              git checkout -q "${ORIGINAL_BRANCH}"
            else
              git checkout -q "${ORIGINAL_SHA}"
            fi

            git replace -f "${BROKEN_SHA}" "${FIX_SHA}"
          done

          echo "Replacements applied:"
          git replace -l || true

          # Sanity check: ensure `git checkout <sha>` yields a workspace with `derive/Cargo.toml`.
          for sha in "${BROKEN_COMMITS[@]}"; do
            git checkout -q "${sha}"
            if [[ ! -f derive/Cargo.toml ]]; then
              echo "Sanity check failed: derive/Cargo.toml missing at commit ${sha}"
              exit 1
            fi
          done
          git checkout -q "${ORIGINAL_BRANCH}"
      - uses: dtolnay/rust-toolchain@nightly
      - name: Install release-plz
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-semver-checks@0.45, release-plz@0.3.150
      - name: Run release-plz
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "-- Running release-plz release-pr --"
          env -u GIT_NO_REPLACE_OBJECTS release-plz release-pr \
            --git-token "${GITHUB_TOKEN}" \
            --repo-url "https://github.com/${GITHUB_REPOSITORY}" \
            --config release-plz.toml
          echo "-- Running release-plz release --"
          env -u GIT_NO_REPLACE_OBJECTS release-plz release \
            --git-token "${GITHUB_TOKEN}" \
            --config release-plz.toml
