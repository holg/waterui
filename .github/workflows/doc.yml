name: Deploy WaterUI Docs to Cloudflare Pages

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: cf-pages-docs
  cancel-in-progress: false

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            deploy/cache
          key: ${{ runner.os }}-cargo-doc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-doc-

      - name: Build rustdoc (into cache, then copy to version)
        env:
          RUSTDOCFLAGS: "--cfg docsrs"
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="main"
          fi
          echo "ðŸ“˜ Building WaterUI docs for version: $VERSION"

          mkdir -p deploy/cache
          # Build docs (adjust -p if your crate name differs)
          cargo doc -p waterui --no-deps --target-dir deploy/cache

          mkdir -p "deploy/$VERSION"
          cp -r deploy/cache/doc/* "deploy/$VERSION/"

      - name: Sanity check: crate docs exist
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="main"
          fi
          # CHANGE 'waterui' if your crate directory is different
          if [[ ! -f "deploy/$VERSION/waterui/index.html" ]]; then
            echo "::error::Expected docs at deploy/$VERSION/waterui/index.html but not found."
            echo "Contents of deploy/$VERSION:"
            ls -la "deploy/$VERSION" || true
            exit 1
          fi

      - name: Determine latest stable tag
        id: stable
        run: |
          TAGS=$(git tag -l "v*" | sort -Vr)
          STABLE_TAG=$(echo "$TAGS" | head -n 1)
          if [ -z "$STABLE_TAG" ]; then
            echo "stable=main" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: main"
          else
            echo "stable=$STABLE_TAG" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: $STABLE_TAG"
          fi

      # Make each version's index an absolute redirect to its crate docs,
      # avoiding rustdoc's relative redirect surprises.
      - name: Write version index redirect
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="main"
          fi
          mkdir -p "deploy/$VERSION"
          cat > "deploy/$VERSION/index.html" <<EOF
          <!DOCTYPE html>
          <meta http-equiv="refresh" content="0; url=/${VERSION}/waterui/">
          <script>location.replace("/${VERSION}/waterui/");</script>
          EOF

      # Use CF Pages _redirects to send "/" to the latest stable (or main).
      - name: Write root redirects and 404 (disable SPA fallback)
        run: |
          TARGET="${{ steps.stable.outputs.stable }}"
          mkdir -p deploy
          # Root redirect as HTTP 302 via _redirects:
          # (prevents any HTML-based loops)
          echo "/  /$TARGET/ 302" > deploy/_redirects
          # Add a simple 404 to DISABLE SPA fallback (critical!)
          # Without this, CF Pages serves "/" on 404, which can cause loops.
          cat > deploy/404.html <<'EOF'
          <!DOCTYPE html>
          <html><head><meta charset="utf-8"><title>404 Not Found</title></head>
          <body><h1>404</h1><p>Not found.</p></body></html>
          EOF

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./deploy --project-name=waterui-docs --commit-dirty=true