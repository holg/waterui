name: Deploy WaterUI Docs to Cloudflare Pages

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: cf-pages-docs
  cancel-in-progress: false

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # need tags

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            deploy/cache
          key: ${{ runner.os }}-cargo-doc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-doc-

      - name: Build rustdoc (cache â†’ version dir)
        env:
          RUSTDOCFLAGS: "--cfg docsrs"
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="main"
          fi
          echo "ðŸ“˜ Building WaterUI docs for version: $VERSION"

          mkdir -p deploy/cache
          cargo doc -p waterui --no-deps --target-dir deploy/cache

          mkdir -p "deploy/$VERSION"
          cp -r deploy/cache/doc/* "deploy/$VERSION/"

      - name: Sanity check - crate docs exist
        run: |
          V="${GITHUB_REF_TYPE == 'tag' && GITHUB_REF_NAME || 'main'}"
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then V="${GITHUB_REF_NAME}"; else V="main"; fi
          if [[ ! -f "deploy/$V/waterui/index.html" ]]; then
            echo "::error::Expected deploy/$V/waterui/index.html but not found."
            echo "deploy/$V contents:"; ls -la "deploy/$V" || true
            exit 1
          fi

      - name: Determine latest stable tag
        id: stable
        run: |
          TAGS=$(git tag -l "v*" | sort -Vr)
          STABLE_TAG=$(echo "$TAGS" | head -n 1)
          if [ -z "$STABLE_TAG" ]; then
            echo "stable=main" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: main"
          else
            echo "stable=$STABLE_TAG" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: $STABLE_TAG"
          fi
          # also export all tags (for redirects)
          # write newline-separated list to a file we'll reuse
          echo "$TAGS" > all_tags.txt

      - name: Write _redirects and 404 (server-side)
        run: |
          mkdir -p deploy
          TARGET="${{ steps.stable.outputs.stable }}"
          # Root â†’ latest stable
          echo "/  /$TARGET/ 302" > deploy/_redirects
          # Make /main land where the crate actually lives (ONE redirect, no loops)
          echo "/main  /main/waterui/ 302" >> deploy/_redirects
          # For each tag, make /vX.Y.Z land at that crate root too
          while read -r t; do
            [ -z "$t" ] && continue
            echo "/$t  /$t/waterui/ 302" >> deploy/_redirects
          done < all_tags.txt

          # Disable SPA fallback: serve a real 404 so CF doesn't bounce to "/"
          cat > deploy/404.html <<'EOF'
          <!DOCTYPE html>
          <meta charset="utf-8">
          <title>404 Not Found</title>
          <h1>404</h1><p>Not found.</p>
          EOF

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./deploy --project-name=waterui-docs --commit-dirty=true
