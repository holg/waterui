name: Deploy WaterUI Docs to Cloudflare Pages

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: cf-pages-docs
  cancel-in-progress: false

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            deploy/cache
          key: ${{ runner.os }}-cargo-doc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-doc-

      - name: Build rustdoc
        env:
          RUSTDOCFLAGS: "--cfg docsrs"
        run: |
          set -euxo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="main"
          fi

          echo "ðŸ“˜ Building WaterUI docs for version: $VERSION"
          mkdir -p deploy/cache
          cargo doc -p waterui --no-deps --target-dir deploy/cache

          mkdir -p "deploy/$VERSION"
          cp -r deploy/cache/doc/* "deploy/$VERSION/"

      - name: Sanity check - crate docs exist
        run: |
          set -euxo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            V="${GITHUB_REF_NAME}"
          else
            V="main"
          fi
          if [[ ! -f "deploy/$V/waterui/index.html" ]]; then
            echo "::error::Expected deploy/$V/waterui/index.html but not found."
            echo "deploy/$V contents:"; ls -la "deploy/$V" || true
            exit 1
          fi

      - name: Determine latest stable tag
        id: stable
        run: |
          set -e
          TAGS=$(git tag -l "v*" | sort -Vr)
          STABLE_TAG=$(echo "$TAGS" | head -n 1)
          if [ -z "$STABLE_TAG" ]; then
            echo "stable=main" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: main"
          else
            echo "stable=$STABLE_TAG" >> $GITHUB_OUTPUT
            echo "âž¡ï¸ Stable version: $STABLE_TAG"
          fi

      - name: Write root redirects and 404
        run: |
          set -e
          mkdir -p deploy
          TARGET="${{ steps.stable.outputs.stable }}"
          echo "/  /$TARGET/ 302" > deploy/_redirects
          cat > deploy/404.html <<'EOF'
          <!DOCTYPE html><meta charset="utf-8">
          <title>404 Not Found</title><h1>404</h1><p>Not found.</p>
          EOF

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./deploy --project-name=waterui-docs --commit-dirty=true
